# Admin Quotes View - Implementation Plan

**Feature ID:** ADMIN-001
**Priority:** P0 (BLOCKING)
**Effort:** M (Medium)
**Owner:** CTO
**Status:** Backend COMPLETE - Frontend Ready to Build
**Created:** December 7, 2025
**Backend Completed:** December 7, 2025

---

## Executive Summary

Add a comprehensive quotes management dashboard to the Durdle admin interface, allowing admins to view all customer quotes, track conversion rates, identify abandoned quotes, and provide customer support.

**Business Value:**
- Visibility into customer demand patterns
- Track quote-to-booking conversion rate (critical KPI for Phase 3)
- Identify abandoned quotes for follow-up campaigns
- Customer support can retrieve quotes by reference ID

**Technical Complexity:** Medium
- New Lambda function for quote queries
- Frontend table component with advanced filtering
- Real-time status updates
- CSV export functionality

---

## User Stories

### Primary User Story (ADMIN-001)
**As an admin**, I need to see all quotes generated by customers so I can monitor interest, track conversion rates, and provide customer support.

**Acceptance Criteria:**
- [ ] Admin dashboard page at `/admin/quotes`
- [ ] Table displays: Quote ID, Created Date, Customer Email (if provided), Pickup Location, Dropoff Location, Price, Status (Active/Expired/Converted)
- [ ] Filter by: Status, Date Range, Price Range
- [ ] Search by: Quote ID, Location
- [ ] Sort by: Date (newest first default), Price
- [ ] Pagination: 50 quotes per page
- [ ] Click quote row to view full details (map, route, waypoints, pricing breakdown)
- [ ] Export to CSV button
- [ ] Real-time status updates (quote expiration, conversion to booking)
- [ ] Show "Converted to Booking" badge with booking reference link

---

## Current State Analysis

### Existing Infrastructure

**DynamoDB Table: `durdle-quotes-dev`**
```typescript
interface Quote {
  quoteId: string;           // PK: "QUOTE#abc123"
  createdAt: string;         // ISO timestamp
  expiresAt: string;         // ISO timestamp (15 mins after creation)
  status: 'active' | 'expired' | 'converted';

  // Journey details
  pickupLocation: Location;
  dropoffLocation: Location;
  waypoints?: Location[];
  pickupTime: string;        // ISO timestamp

  // Pricing
  totalPrice: number;
  vehicleType: string;       // "standard", "executive", "minibus"
  pricingBreakdown: {
    baseFare: number;
    distanceCost: number;
    waypointCost?: number;
  };

  // Optional customer info
  customerEmail?: string;
  customerPhone?: string;

  // Metadata
  ipAddress?: string;
  userAgent?: string;
  bookingId?: string;        // Set when converted to booking
}

interface Location {
  address: string;
  placeId: string;
  coordinates: {
    lat: number;
    lng: number;
  };
}
```

**Existing Lambda:** `quotes-calculator`
- **Purpose:** Generates new quotes based on customer input
- **Does NOT have:** Admin query functionality

**Admin Authentication:**
- Existing JWT-based auth via `admin-auth` Lambda
- Session management already implemented
- Admin routes protected in Next.js middleware

---

## BACKEND IMPLEMENTATION - COMPLETE ✅

**Status:** Backend is 100% complete and ready for deployment
**Location:** `durdle-serverless-api/functions/quotes-manager/`
**Deployment Guide:** See [DEPLOYMENT_GUIDE.md](../../durdle-serverless-api/functions/quotes-manager/DEPLOYMENT_GUIDE.md)

### What's Been Built

The complete backend Lambda function `quotes-manager` has been implemented with:

- **Main handler** ([index.mjs](../../durdle-serverless-api/functions/quotes-manager/index.mjs)) - Request routing, auth verification, error handling
- **Query logic** ([queries.mjs](../../durdle-serverless-api/functions/quotes-manager/queries.mjs)) - DynamoDB queries with GSI, filtering, pagination
- **Validation** ([validation.mjs](../../durdle-serverless-api/functions/quotes-manager/validation.mjs)) - Zod schemas for all request parameters
- **CSV Export** ([csv-export.mjs](../../durdle-serverless-api/functions/quotes-manager/csv-export.mjs)) - CSV generation utility
- **Migration script** ([backfill-quote-status.mjs](../../durdle-serverless-api/functions/quotes-manager/backfill-quote-status.mjs)) - Adds status field to existing quotes
- **Unit tests** - CSV export and validation tests
- **Complete documentation** - STRUCTURE.md, DEPLOYMENT_GUIDE.md, README.md

### API Endpoints for Frontend (Ready to Use)

**Base URL:** `https://qry0k6pmd0.execute-api.eu-west-2.amazonaws.com` (after API Gateway setup)

#### 1. List Quotes

```http
GET /api/admin/quotes
Authorization: Bearer {admin-jwt-token}
```

**Query Parameters:**
```typescript
{
  status?: 'all' | 'active' | 'expired' | 'converted';  // Default: 'all'
  dateFrom?: string;                                     // ISO datetime, Default: 30 days ago
  dateTo?: string;                                       // ISO datetime, Default: now
  priceMin?: number;                                     // Default: 0
  priceMax?: number;                                     // Default: unlimited
  search?: string;                                       // Searches quote ID, locations, email
  sortBy?: 'date' | 'price';                            // Default: 'date'
  sortOrder?: 'asc' | 'desc';                           // Default: 'desc'
  limit?: number;                                        // Default: 50, Max: 100
  cursor?: string;                                       // Pagination cursor from previous response
}
```

**Response:**
```typescript
{
  quotes: Quote[];
  pagination: {
    total: number;
    limit: number;
    cursor: string | null;  // null if no more results
  }
}
```

**Example Request:**
```javascript
const response = await fetch('/api/admin/quotes?status=active&limit=25', {
  headers: {
    'Authorization': `Bearer ${jwtToken}`
  }
});
const data = await response.json();
```

#### 2. Get Quote Details

```http
GET /api/admin/quotes/{quoteId}
Authorization: Bearer {admin-jwt-token}
```

**Path Parameters:**
- `quoteId` - Quote ID (format: `QUOTE#abc123`)

**Response:**
```typescript
Quote  // Full quote object (see Quote interface below)
```

**Example Request:**
```javascript
const response = await fetch('/api/admin/quotes/QUOTE#abc123', {
  headers: {
    'Authorization': `Bearer ${jwtToken}`
  }
});
const quote = await response.json();
```

#### 3. Export to CSV

```http
GET /api/admin/quotes/export
Authorization: Bearer {admin-jwt-token}
```

**Query Parameters:** Same as List Quotes (except no `limit` or `cursor`)

**Response:** CSV file download with filename `durdle-quotes-YYYY-MM-DD.csv`

**Example Request:**
```javascript
const response = await fetch('/api/admin/quotes/export?status=active', {
  headers: {
    'Authorization': `Bearer ${jwtToken}`
  }
});
const blob = await response.blob();
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `durdle-quotes-${new Date().toISOString().split('T')[0]}.csv`;
a.click();
```

### TypeScript Interfaces for Frontend

```typescript
interface Quote {
  quoteId: string;           // "QUOTE#abc123"
  createdAt: string;         // ISO timestamp
  expiresAt: string;         // ISO timestamp (15 mins after creation)
  status: 'active' | 'expired' | 'converted';

  // Journey details
  pickupLocation: Location;
  dropoffLocation: Location;
  waypoints?: Location[];
  pickupTime: string;        // ISO timestamp

  // Pricing
  totalPrice: number;
  vehicleType: string;       // "standard", "executive", "minibus"
  pricingBreakdown: {
    baseFare: number;
    distanceCost: number;
    waypointCost?: number;
  };

  // Optional customer info
  customerEmail?: string;
  customerPhone?: string;

  // Metadata
  ipAddress?: string;
  userAgent?: string;
  bookingId?: string;        // Set when converted to booking
}

interface Location {
  address: string;
  placeId: string;
  coordinates: {
    lat: number;
    lng: number;
  };
}

interface QuotesListResponse {
  quotes: Quote[];
  pagination: {
    total: number;
    limit: number;
    cursor: string | null;
  };
}
```

### Error Responses

All endpoints return standard error responses:

```typescript
{
  error: string;           // Human-readable error message
  errors?: Array<{         // Validation errors (if applicable)
    field: string;
    message: string;
  }>;
}
```

**Status Codes:**
- `200` - Success
- `400` - Bad Request (validation error)
- `401` - Unauthorized (missing/invalid JWT)
- `404` - Not Found (quote doesn't exist)
- `500` - Internal Server Error

### Before Frontend Development Starts

The backend team (or CTO) must:

1. **Deploy DynamoDB GSI:**
   ```bash
   aws dynamodb update-table \
     --table-name durdle-quotes-dev \
     --region eu-west-2 \
     --attribute-definitions \
       AttributeName=status,AttributeType=S \
       AttributeName=createdAt,AttributeType=S \
     --global-secondary-index-updates \
       "[{\"Create\":{\"IndexName\":\"status-createdAt-index\",\"KeySchema\":[{\"AttributeName\":\"status\",\"KeyType\":\"HASH\"},{\"AttributeName\":\"createdAt\",\"KeyType\":\"RANGE\"}],\"Projection\":{\"ProjectionType\":\"ALL\"}}}]"
   ```

2. **Backfill quote status:**
   ```bash
   cd durdle-serverless-api/functions/quotes-manager
   node backfill-quote-status.mjs
   ```

3. **Deploy Lambda function:**
   Follow commands in [STRUCTURE.md](../../durdle-serverless-api/functions/quotes-manager/STRUCTURE.md)

4. **Configure API Gateway:**
   Add routes and permissions (see [DEPLOYMENT_GUIDE.md](../../durdle-serverless-api/functions/quotes-manager/DEPLOYMENT_GUIDE.md))

5. **Test endpoints:**
   Verify all three endpoints work via curl/Postman

### Frontend Team - Next Steps

You can now build the admin UI at `/admin/quotes` following the specifications below. The backend API is ready to consume.

**Recommended approach:**
1. Start with basic table showing quotes list
2. Add filtering UI
3. Implement pagination
4. Add quote details modal
5. Add CSV export button
6. Polish with loading states, error handling, responsive design

**Important Notes:**
- All API calls require admin JWT token in `Authorization` header
- Use the `cursor` from pagination response for next page (not offset-based)
- Quote status can be calculated client-side: if `expiresAt < now`, show as expired
- For active quotes, show countdown timer using `expiresAt` timestamp

---

## Technical Implementation

### 1. Backend: New Lambda Function (COMPLETED ✅)

**Lambda Name:** `quotes-manager-dev`
**Runtime:** Node.js 20.x (arm64)
**Lambda Layer:** durdle-common-layer:3 (for structured logging)

**Functionality:**
- Query quotes from DynamoDB with filtering
- Pagination using DynamoDB cursor-based pagination
- Sort by date, price
- Search by quote ID, location text
- Export to CSV format

**File Structure:**
```
durdle-serverless-api/functions/quotes-manager/
├── index.mjs              # Main Lambda handler
├── queries.mjs            # DynamoDB query logic
├── validation.mjs         # Zod schemas for request validation
├── csv-export.mjs         # CSV generation utility
├── package.json
├── package-lock.json
├── STRUCTURE.md           # Deployment guide
└── tests/
    └── queries.test.mjs
```

**API Endpoints:**
```typescript
// List quotes with filters
GET /api/admin/quotes
Query Parameters:
  - status: 'active' | 'expired' | 'converted' | 'all' (default: 'all')
  - dateFrom: ISO date string (default: 30 days ago)
  - dateTo: ISO date string (default: now)
  - priceMin: number (default: 0)
  - priceMax: number (default: 999999)
  - search: string (searches quote ID and locations)
  - sortBy: 'date' | 'price' (default: 'date')
  - sortOrder: 'asc' | 'desc' (default: 'desc')
  - limit: number (default: 50, max: 100)
  - cursor: string (pagination cursor from previous response)

Response:
{
  "quotes": Quote[],
  "pagination": {
    "total": number,
    "limit": number,
    "cursor": string | null  // null if no more results
  }
}

// Get single quote details
GET /api/admin/quotes/:quoteId
Response: Quote

// Export to CSV
GET /api/admin/quotes/export
Query Parameters: (same as list, except no limit/cursor)
Response: CSV file download
```

**DynamoDB Query Strategy:**

1. **Status Filter:**
   - Create GSI: `status-createdAt-index`
   - PK: status, SK: createdAt
   - Allows efficient filtering by status + date range

2. **Date Range Filter:**
   - Use `FilterExpression` on createdAt if no status filter
   - Or use GSI if status provided

3. **Price Filter:**
   - Use `FilterExpression` (cannot index on numeric range efficiently)

4. **Search:**
   - Use `FilterExpression` with `contains()` on quote ID and location addresses
   - Not ideal for performance, but acceptable for admin use (low volume)

5. **Pagination:**
   - Use DynamoDB `ExclusiveStartKey` for cursor-based pagination
   - Encode cursor as base64 to pass in URL

**GSI Schema:**
```typescript
{
  TableName: 'durdle-quotes-dev',
  GlobalSecondaryIndexes: [
    {
      IndexName: 'status-createdAt-index',
      KeySchema: [
        { AttributeName: 'status', KeyType: 'HASH' },
        { AttributeName: 'createdAt', KeyType: 'RANGE' }
      ],
      Projection: { ProjectionType: 'ALL' }
    }
  ]
}
```

**Lambda IAM Permissions:**
```json
{
  "Effect": "Allow",
  "Action": [
    "dynamodb:Query",
    "dynamodb:Scan",
    "dynamodb:GetItem"
  ],
  "Resource": [
    "arn:aws:dynamodb:eu-west-2:771551874768:table/durdle-quotes-dev",
    "arn:aws:dynamodb:eu-west-2:771551874768:table/durdle-quotes-dev/index/*"
  ]
}
```

**Structured Logging Events:**
```typescript
// Sample log events
logger.info({ event: 'quotes_query', filters, resultCount }, 'Quotes queried');
logger.info({ event: 'quote_details_fetched', quoteId }, 'Quote details retrieved');
logger.info({ event: 'csv_export', quoteCount }, 'CSV export generated');
logger.error({ event: 'query_error', error: err.message }, 'Query failed');
```

---

### 2. Frontend: Admin Quotes Page

**Route:** `/admin/quotes`
**Component:** `app/admin/quotes/page.tsx`

**UI Components Hierarchy:**
```
QuotesPage
├── QuotesFilters (status, date range, price, search)
├── QuotesTable (sortable columns, clickable rows)
│   ├── QuoteRow × N
│   └── Pagination
├── QuoteDetailsModal (opens on row click)
└── ExportButton
```

**Component: QuotesFilters.tsx**
```typescript
interface QuotesFiltersProps {
  filters: QuoteFilters;
  onFilterChange: (filters: QuoteFilters) => void;
}

interface QuoteFilters {
  status: 'all' | 'active' | 'expired' | 'converted';
  dateFrom: Date;
  dateTo: Date;
  priceMin: number;
  priceMax: number;
  search: string;
}

// UI Elements:
// - Status: Radio buttons (All, Active, Expired, Converted)
// - Date Range: Date pickers (From, To) with presets (Today, Last 7 days, Last 30 days)
// - Price Range: Number inputs (Min £, Max £)
// - Search: Text input with debounce (Quote ID or Location)
// - Clear Filters button
```

**Component: QuotesTable.tsx**
```typescript
interface QuotesTableProps {
  quotes: Quote[];
  sortBy: 'date' | 'price';
  sortOrder: 'asc' | 'desc';
  onSort: (column: string) => void;
  onRowClick: (quoteId: string) => void;
  pagination: PaginationInfo;
  onPageChange: (cursor: string | null) => void;
}

// Columns:
// 1. Quote ID (e.g., "QUOTE#abc123" → display as "#abc123")
// 2. Created Date (formatted as "Dec 7, 2025 10:30 AM")
// 3. Customer Email (or "—" if not provided)
// 4. Pickup Location (truncate to 40 chars)
// 5. Dropoff Location (truncate to 40 chars)
// 6. Price (formatted as "£28.00")
// 7. Status Badge (color-coded: Active=green, Expired=gray, Converted=blue)
// 8. Actions (View Details button)

// Sorting:
// - Click column header to sort
// - Arrow icon shows current sort direction

// Pagination:
// - "Previous" button (disabled if first page)
// - "Next" button (disabled if last page)
// - "Showing 1-50 of 234 quotes"
```

**Component: QuoteDetailsModal.tsx**
```typescript
interface QuoteDetailsModalProps {
  quoteId: string;
  onClose: () => void;
}

// Modal Content:
// - Quote Reference: #abc123
// - Status Badge (with expiry countdown if active)
// - Created: Dec 7, 2025 10:30 AM
// - Expires: Dec 7, 2025 10:45 AM (in 12 minutes) ← countdown timer if active
// - Customer Email: sarah@example.com (or "Not provided")
// - Pickup: Bournemouth Station, Bournemouth BH1 3EG
// - Dropoff: London Heathrow Airport, TW6 1EW
// - Waypoints: (if any) Display as numbered list
// - Pickup Time: Dec 10, 2025 14:30
// - Vehicle Type: Executive Saloon
// - Pricing Breakdown:
//   - Base Fare: £15.00
//   - Distance (82 miles @ £1.50/mile): £123.00
//   - Total: £138.00
// - Map: Route visualization with pickup, dropoff, waypoints
// - Booking Status:
//   - If converted: "Converted to Booking #DURDLE-12345" (link to booking)
//   - If expired: "Expired on Dec 7, 2025 10:45 AM"
//   - If active: "Active - Expires in 12 minutes"
// - Actions:
//   - Close button
//   - View on Map (opens Google Maps with route)
//   - Copy Quote Link (for customer support)
```

**Component: ExportButton.tsx**
```typescript
// Button that triggers CSV download
// Shows loading state while generating CSV
// Downloads file as "durdle-quotes-{date}.csv"

async function handleExport() {
  setLoading(true);
  const response = await fetch('/api/admin/quotes/export?' + queryString);
  const blob = await response.blob();
  downloadFile(blob, `durdle-quotes-${new Date().toISOString()}.csv`);
  setLoading(false);
}
```

**CSV Export Format:**
```csv
Quote ID,Created Date,Status,Customer Email,Pickup Location,Dropoff Location,Pickup Time,Vehicle Type,Price,Booking ID
#abc123,2025-12-07 10:30:00,Active,,Bournemouth Station,London Heathrow,2025-12-10 14:30:00,Executive,£138.00,
#def456,2025-12-07 09:15:00,Converted,sarah@example.com,Dorset,Gatwick,2025-12-08 08:00:00,Standard,£95.00,DURDLE-12345
```

---

### 3. State Management

**Use React Query for server state:**
```typescript
// hooks/useQuotes.ts
export function useQuotes(filters: QuoteFilters, pagination: PaginationState) {
  return useQuery({
    queryKey: ['quotes', filters, pagination],
    queryFn: () => fetchQuotes(filters, pagination),
    staleTime: 30000, // 30 seconds
    refetchInterval: 60000, // Refresh every minute for status updates
  });
}

export function useQuoteDetails(quoteId: string) {
  return useQuery({
    queryKey: ['quote', quoteId],
    queryFn: () => fetchQuoteDetails(quoteId),
    enabled: !!quoteId,
  });
}
```

**URL state sync for filters:**
```typescript
// Sync filters to URL query params for bookmarkability
// Example: /admin/quotes?status=active&dateFrom=2025-12-01&search=heathrow
import { useSearchParams } from 'next/navigation';

function QuotesPage() {
  const searchParams = useSearchParams();
  const [filters, setFilters] = useState<QuoteFilters>({
    status: searchParams.get('status') as QuoteFilters['status'] || 'all',
    dateFrom: new Date(searchParams.get('dateFrom') || getDate30DaysAgo()),
    // ... etc
  });

  // Update URL when filters change
  useEffect(() => {
    const params = new URLSearchParams();
    params.set('status', filters.status);
    params.set('dateFrom', filters.dateFrom.toISOString());
    // ...
    router.push(`/admin/quotes?${params.toString()}`, { scroll: false });
  }, [filters]);
}
```

---

### 4. Real-Time Updates

**Problem:** Quotes expire after 15 minutes, need UI to reflect this

**Solution 1: Client-Side Countdown (Recommended for MVP)**
```typescript
// Update status badge every second if quote is active
function QuoteStatusBadge({ quote }: { quote: Quote }) {
  const [timeLeft, setTimeLeft] = useState<number>(
    new Date(quote.expiresAt).getTime() - Date.now()
  );

  useEffect(() => {
    const interval = setInterval(() => {
      const remaining = new Date(quote.expiresAt).getTime() - Date.now();
      if (remaining <= 0) {
        setTimeLeft(0);
        // Optionally trigger refetch to update status in backend
      } else {
        setTimeLeft(remaining);
      }
    }, 1000);

    return () => clearInterval(interval);
  }, [quote.expiresAt]);

  if (quote.status === 'expired' || timeLeft <= 0) {
    return <Badge variant="gray">Expired</Badge>;
  }

  if (quote.status === 'converted') {
    return <Badge variant="blue">Converted</Badge>;
  }

  const minutes = Math.floor(timeLeft / 60000);
  const seconds = Math.floor((timeLeft % 60000) / 1000);

  return (
    <Badge variant="green">
      Active - Expires in {minutes}:{seconds.toString().padStart(2, '0')}
    </Badge>
  );
}
```

**Solution 2: WebSocket Updates (Future Enhancement)**
- EventBridge scheduled rule triggers Lambda every 1 minute
- Lambda scans for expired quotes, updates status
- Publishes event to WebSocket API
- Frontend listens and updates UI
- **Defer to post-MVP** (adds complexity, client-side is sufficient for now)

---

## Database Schema Updates

**Add GSI to `durdle-quotes-dev` table:**

```bash
# AWS CLI command to add GSI
aws dynamodb update-table \
  --table-name durdle-quotes-dev \
  --region eu-west-2 \
  --attribute-definitions \
    AttributeName=status,AttributeType=S \
    AttributeName=createdAt,AttributeType=S \
  --global-secondary-index-updates \
    "[{\"Create\":{\"IndexName\":\"status-createdAt-index\",\"KeySchema\":[{\"AttributeName\":\"status\",\"KeyType\":\"HASH\"},{\"AttributeName\":\"createdAt\",\"KeyType\":\"RANGE\"}],\"Projection\":{\"ProjectionType\":\"ALL\"},\"ProvisionedThroughput\":{\"ReadCapacityUnits\":5,\"WriteCapacityUnits\":5}}}]"
```

**Note:** If table is using on-demand billing (likely), use:
```bash
aws dynamodb update-table \
  --table-name durdle-quotes-dev \
  --region eu-west-2 \
  --attribute-definitions \
    AttributeName=status,AttributeType=S \
    AttributeName=createdAt,AttributeType=S \
  --global-secondary-index-updates \
    "[{\"Create\":{\"IndexName\":\"status-createdAt-index\",\"KeySchema\":[{\"AttributeName\":\"status\",\"KeyType\":\"HASH\"},{\"AttributeName\":\"createdAt\",\"KeyType\":\"RANGE\"}],\"Projection\":{\"ProjectionType\":\"ALL\"}}}]"
```

**Backfill existing quotes with status field:**
```javascript
// One-time migration script
// Run in AWS Lambda or locally with AWS SDK

import { DynamoDBClient } from '@aws-sdk/client-dynamodb';
import { DynamoDBDocumentClient, ScanCommand, UpdateCommand } from '@aws-sdk/lib-dynamodb';

const client = DynamoDBDocumentClient.from(new DynamoDBClient({ region: 'eu-west-2' }));

async function backfillQuoteStatus() {
  const scanResult = await client.send(new ScanCommand({
    TableName: 'durdle-quotes-dev'
  }));

  for (const item of scanResult.Items) {
    // Calculate status based on expiresAt and bookingId
    const now = new Date();
    const expiresAt = new Date(item.expiresAt);

    let status;
    if (item.bookingId) {
      status = 'converted';
    } else if (now > expiresAt) {
      status = 'expired';
    } else {
      status = 'active';
    }

    // Update item with status
    await client.send(new UpdateCommand({
      TableName: 'durdle-quotes-dev',
      Key: { quoteId: item.quoteId },
      UpdateExpression: 'SET #status = :status',
      ExpressionAttributeNames: { '#status': 'status' },
      ExpressionAttributeValues: { ':status': status }
    }));
  }

  console.log(`Backfilled ${scanResult.Items.length} quotes with status`);
}
```

---

## API Gateway Configuration

**Add new routes to API Gateway:**

```yaml
# In API Gateway console or SAM/CloudFormation template
/admin/quotes:
  get:
    x-amazon-apigateway-integration:
      uri: arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:771551874768:function:quotes-manager-dev/invocations
      httpMethod: POST
      type: aws_proxy
    security:
      - CognitoAuthorizer: []  # Requires admin JWT token

/admin/quotes/{quoteId}:
  get:
    x-amazon-apigateway-integration:
      uri: arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:771551874768:function:quotes-manager-dev/invocations
      httpMethod: POST
      type: aws_proxy
    security:
      - CognitoAuthorizer: []

/admin/quotes/export:
  get:
    x-amazon-apigateway-integration:
      uri: arn:aws:apigateway:eu-west-2:lambda:path/2015-03-31/functions/arn:aws:lambda:eu-west-2:771551874768:function:quotes-manager-dev/invocations
      httpMethod: POST
      type: aws_proxy
    security:
      - CognitoAuthorizer: []
```

**CORS Configuration:**
- Allow origin: `https://admin.durdletransfers.co.uk` (production) and `http://localhost:3000` (dev)
- Allow methods: GET
- Allow headers: Authorization, Content-Type
- Allow credentials: true (for JWT cookies)

---

## Testing Strategy

### 1. Unit Tests

**Backend (`quotes-manager` Lambda):**
```javascript
// tests/queries.test.mjs
describe('Quote Queries', () => {
  test('should filter quotes by status', async () => {
    const result = await queryQuotes({ status: 'active' });
    expect(result.quotes).toHaveLength(5);
    expect(result.quotes.every(q => q.status === 'active')).toBe(true);
  });

  test('should filter quotes by date range', async () => {
    const result = await queryQuotes({
      dateFrom: '2025-12-01',
      dateTo: '2025-12-07'
    });
    expect(result.quotes.every(q => {
      const date = new Date(q.createdAt);
      return date >= new Date('2025-12-01') && date <= new Date('2025-12-07');
    })).toBe(true);
  });

  test('should search quotes by location', async () => {
    const result = await queryQuotes({ search: 'heathrow' });
    expect(result.quotes.some(q =>
      q.pickupLocation.address.toLowerCase().includes('heathrow') ||
      q.dropoffLocation.address.toLowerCase().includes('heathrow')
    )).toBe(true);
  });

  test('should paginate results', async () => {
    const page1 = await queryQuotes({ limit: 10 });
    expect(page1.quotes).toHaveLength(10);
    expect(page1.pagination.cursor).toBeTruthy();

    const page2 = await queryQuotes({ limit: 10, cursor: page1.pagination.cursor });
    expect(page2.quotes).toHaveLength(10);
    expect(page2.quotes[0].quoteId).not.toBe(page1.quotes[0].quoteId);
  });

  test('should generate CSV export', () => {
    const csv = generateCSV(mockQuotes);
    expect(csv).toContain('Quote ID,Created Date,Status');
    expect(csv).toContain('#abc123');
  });
});
```

**Frontend (React components):**
```typescript
// __tests__/QuotesTable.test.tsx
describe('QuotesTable', () => {
  test('should render quotes', () => {
    const { getByText } = render(<QuotesTable quotes={mockQuotes} />);
    expect(getByText('#abc123')).toBeInTheDocument();
  });

  test('should handle row click', () => {
    const onRowClick = jest.fn();
    const { getByText } = render(
      <QuotesTable quotes={mockQuotes} onRowClick={onRowClick} />
    );
    fireEvent.click(getByText('#abc123'));
    expect(onRowClick).toHaveBeenCalledWith('QUOTE#abc123');
  });

  test('should sort by column', () => {
    const onSort = jest.fn();
    const { getByText } = render(
      <QuotesTable quotes={mockQuotes} onSort={onSort} />
    );
    fireEvent.click(getByText('Price'));
    expect(onSort).toHaveBeenCalledWith('price');
  });
});
```

### 2. Integration Tests

**Test Lambda with DynamoDB:**
```javascript
// Use local DynamoDB for integration tests
// OR use AWS SDK mocks

test('should query quotes from DynamoDB', async () => {
  // Seed test data
  await seedQuotes();

  // Invoke Lambda
  const event = {
    httpMethod: 'GET',
    path: '/admin/quotes',
    queryStringParameters: { status: 'active' }
  };

  const result = await handler(event);
  expect(result.statusCode).toBe(200);
  const body = JSON.parse(result.body);
  expect(body.quotes).toBeDefined();
});
```

### 3. E2E Tests

**Use Playwright:**
```typescript
// e2e/admin-quotes.spec.ts
test('admin can view quotes', async ({ page }) => {
  // Login as admin
  await page.goto('/admin/login');
  await page.fill('[name="email"]', 'admin@durdletransfers.co.uk');
  await page.fill('[name="password"]', 'admin123');
  await page.click('button[type="submit"]');

  // Navigate to quotes
  await page.goto('/admin/quotes');
  await expect(page.locator('h1')).toContainText('Quotes');

  // Should see quotes table
  await expect(page.locator('table')).toBeVisible();
  await expect(page.locator('tbody tr')).toHaveCount(50); // First page

  // Filter by status
  await page.click('[data-testid="filter-status-active"]');
  await expect(page.locator('tbody tr [data-status="active"]')).toHaveCount.greaterThan(0);

  // Search by location
  await page.fill('[data-testid="search-input"]', 'heathrow');
  await page.keyboard.press('Enter');
  await expect(page.locator('tbody tr')).toContainText('Heathrow');

  // View quote details
  await page.click('tbody tr:first-child');
  await expect(page.locator('[data-testid="quote-modal"]')).toBeVisible();
  await expect(page.locator('[data-testid="quote-modal"]')).toContainText('Quote Reference');

  // Export CSV
  const downloadPromise = page.waitForEvent('download');
  await page.click('[data-testid="export-button"]');
  const download = await downloadPromise;
  expect(download.suggestedFilename()).toMatch(/durdle-quotes-.*\.csv/);
});
```

---

## Deployment Plan

### Phase 1: Backend (Lambda + Database) - ✅ COMPLETE

**Status:** Backend code is complete. Awaiting deployment to AWS.

**What's Done:**
- ✅ Lambda code written (index.mjs, queries.mjs, validation.mjs, csv-export.mjs)
- ✅ Unit tests created (CSV export, validation)
- ✅ STRUCTURE.md deployment guide created
- ✅ DEPLOYMENT_GUIDE.md with IAM and API Gateway setup
- ✅ Migration script for backfilling quote status
- ✅ Test payloads and documentation

**Remaining Deployment Steps (CTO/DevOps):**
1. **Create GSI on DynamoDB table** (15 mins)
   - Run AWS CLI command to add `status-createdAt-index`
   - Wait for index to backfill (5-10 mins for small tables)

2. **Backfill quote status** (10 mins)
   - Run migration script: `node backfill-quote-status.mjs`
   - Verify data integrity

3. **Deploy `quotes-manager` Lambda** (15 mins)
   - Follow commands in STRUCTURE.md
   - Test manually with test payloads

4. **Update API Gateway** (15 mins)
   - Add routes: `/admin/quotes`, `/admin/quotes/{quoteId}`, `/admin/quotes/export`
   - Add Lambda permissions
   - Test authentication (JWT token required)

**Total Deployment Time:** ~55 mins

### Phase 2: Frontend (Admin UI)
1. **Create page component** (1 hour)
   - `app/admin/quotes/page.tsx`
   - Basic table layout
   - Fetch quotes from API

2. **Add filters** (1 hour)
   - Status filter (radio buttons)
   - Date range picker
   - Price range inputs
   - Search input with debounce

3. **Add sorting & pagination** (30 mins)
   - Sortable table headers
   - Previous/Next buttons
   - Cursor-based pagination

4. **Quote details modal** (1.5 hours)
   - Modal component
   - Fetch quote details on open
   - Display journey map
   - Show pricing breakdown
   - Booking conversion status

5. **CSV export** (30 mins)
   - Export button
   - Loading state
   - File download

6. **Polish & responsive design** (1 hour)
   - Mobile layout
   - Loading skeletons
   - Empty states
   - Error handling

**Total Frontend Time:** ~5.5 hours

### Phase 3: Testing & QA
1. **Unit tests** (1 hour)
2. **Integration tests** (30 mins)
3. **E2E tests** (1 hour)
4. **Manual QA** (30 mins)
5. **Bug fixes** (1 hour)

**Total Testing Time:** ~4 hours

### Phase 4: Documentation & Launch
1. **Update STRUCTURE.md** (15 mins)
2. **Update admin user guide** (30 mins)
3. **Deploy to production** (15 mins)
4. **Smoke test** (15 mins)

**Total Launch Time:** ~1 hour

---

## Total Effort Estimate

**Backend:** 1.5 hours
**Frontend:** 5.5 hours
**Testing:** 4 hours
**Launch:** 1 hour

**Total:** 12 hours (1.5 days)

**Classification:** Medium effort (aligns with backlog estimate)

---

## Dependencies

**Must Complete Before Starting:**
- [x] Admin authentication system (COMPLETE ✅)
- [x] DynamoDB `durdle-quotes-dev` table exists (COMPLETE ✅)
- [x] Existing quotes have `expiresAt` field (COMPLETE ✅)
- [x] **Backend Lambda `quotes-manager` built** (COMPLETE ✅ - awaiting deployment)

**Blockers for Frontend Development:**
- Backend must be deployed to AWS (CTO/DevOps task - ~55 mins)
- API Gateway routes must be configured
- GSI must be created and backfilled

**Once Backend Deployed:**
- Frontend can start immediately
- Use API specifications in "BACKEND IMPLEMENTATION - COMPLETE" section above

**Nice to Have (can defer):**
- Real-time WebSocket updates (use client-side countdown instead)
- Advanced analytics (conversion funnel, abandonment reasons) - separate feature (ADMIN-002)

---

## Success Criteria

**Functional:**
- [ ] Admin can view list of all quotes
- [ ] Admin can filter by status, date, price
- [ ] Admin can search by quote ID or location
- [ ] Admin can sort by date or price
- [ ] Admin can paginate through results
- [ ] Admin can view full quote details
- [ ] Admin can export quotes to CSV
- [ ] Quote status updates in real-time (countdown for active quotes)
- [ ] Converted quotes show booking reference link

**Performance:**
- [ ] Initial page load <2 seconds
- [ ] API response time <500ms (p95)
- [ ] Table renders 50 quotes smoothly (no lag)
- [ ] CSV export completes in <5 seconds for 1000 quotes

**Quality:**
- [ ] 80%+ test coverage
- [ ] Zero console errors
- [ ] Responsive design works on mobile/tablet
- [ ] Accessible (keyboard navigation, screen readers)

---

## Risks & Mitigations

### Risk 1: GSI Creation Downtime
**Risk:** Creating GSI on existing table may cause temporary performance degradation
**Impact:** Medium (admin dashboard may be slow for 5-10 mins)
**Likelihood:** Low
**Mitigation:**
- Create GSI during low-traffic hours (e.g., 3 AM GMT)
- Monitor CloudWatch metrics during creation
- If issues, GSI creation can be cancelled

### Risk 2: Large Quote Volume Performance
**Risk:** Fetching 10,000+ quotes may be slow
**Impact:** High (poor admin UX)
**Likelihood:** Medium (if platform is successful)
**Mitigation:**
- Use pagination (max 100 results per page)
- Add DynamoDB caching (DAX) if needed
- Consider archiving old quotes to separate table after 90 days

### Risk 3: CSV Export Timeout
**Risk:** Generating CSV for 10,000+ quotes may exceed Lambda timeout (30s)
**Impact:** Medium (export fails)
**Likelihood:** Low (initially, but higher as volume grows)
**Mitigation:**
- Start with simple export (current filters only, max 1000 quotes)
- Add async export for large datasets (upload to S3, email download link)
- Defer to future enhancement if needed

---

## Follow-On Features

**ADMIN-002: Quote Abandonment Tracking & Analytics**
- Track funnel events (quote_started, quote_viewed, quote_expired, quote_converted)
- Analytics dashboard showing conversion rates
- Abandonment patterns by time, route, vehicle type

**ADMIN-003: Quote-to-Booking Conversion View**
- One-click view of converted quotes → booking details
- Extend quote expiry button (for customer support cases)

**Notification System:**
- Email admin when quote is created
- Slack notification for high-value quotes (>£200)

---

## Open Questions

1. **Should we show customer IP address in quote details?**
   - Pro: Fraud detection
   - Con: Privacy concerns
   - **Recommendation:** Show only to super-admin role, hash IP in database

2. **Should we allow admins to manually create quotes?**
   - Pro: Customer support can create quotes on behalf of customers
   - Con: Adds complexity to UI
   - **Recommendation:** Defer to Phase 2, use existing customer quote form for now

3. **What happens to quotes after 90 days?**
   - Archive to separate DynamoDB table?
   - Delete entirely?
   - **Recommendation:** Keep indefinitely for now, add archiving policy in Phase 3

4. **Should quote status be updated via scheduled job or on-demand?**
   - Scheduled: EventBridge rule every 5 mins updates expired quotes
   - On-demand: Status calculated at query time based on expiresAt
   - **Recommendation:** On-demand (simpler, no scheduled job needed)

---

## Conclusion

This feature is **critical** for Phase 3 launch (P0 BLOCKING). It provides admin visibility into customer demand and enables quote-to-booking conversion tracking.

**Complexity:** Medium (new Lambda, new GSI, substantial frontend work)
**Effort:** 12 hours (~1.5 days)
**Business Impact:** High (foundation for Phase 3 revenue tracking)

**Current Status:** Backend COMPLETE ✅ - Frontend Ready to Build

**Backend Implementation:**
- Complete Lambda function with 3 endpoints
- Full validation with Zod
- Structured logging (24 events)
- Unit tests and documentation
- Ready for deployment (~55 mins deployment time)

**Next Steps for CTO/DevOps:**
1. ✅ ~~Backend implementation~~ (DONE)
2. Deploy GSI to DynamoDB
3. Run backfill migration script
4. Deploy Lambda function to AWS
5. Configure API Gateway routes
6. Test endpoints

**Next Steps for Frontend Team:**
1. Wait for backend deployment
2. Build `/admin/quotes` page using API specs in this document
3. Implement filtering, pagination, CSV export
4. Add quote details modal
5. Test end-to-end with real data

**See "BACKEND IMPLEMENTATION - COMPLETE" section above for:**
- API endpoint specifications
- TypeScript interfaces
- Example requests
- Error handling
- Deployment checklist

---

**Document Owner:** CTO
**Last Updated:** December 7, 2025 (Backend Complete)
**Status:** Backend COMPLETE - Frontend Development Can Begin After Deployment

---

*For questions or clarifications, contact CTO or refer to MASTER_PRODUCT_BACKLOG.md (ADMIN-001)*
